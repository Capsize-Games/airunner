FROM ghcr.io/capsize-games/airunner/airunner:linux

WORKDIR /app

# Set up Python environment variables
ENV PATH="/usr/local/bin:/home/appuser/.local/bin:/home/appuser/.local/share/airunner/python/bin:$PATH"

# Install Qt Wayland support packages for proper window decorations
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    libwayland-client0 \
    libqt6waylandclient6 \
    qt6-gtk-platformtheme \
    && rm -rf /var/lib/apt/lists/*

# Ensure all directories have proper permissions
RUN mkdir -p /home/appuser/.local/lib /home/appuser/.local/bin /home/appuser/.local/share && \
    mkdir -p /home/appuser/.cache && \
    chown -R appuser:appgroup /home/appuser/.local && \
    chmod -R 775 /home/appuser/.local && \
    chown -R appuser:appgroup /home/appuser/.cache && \
    chmod -R 775 /home/appuser/.cache && \
    chmod +x package/dev/entrypoint.sh || true

# Set the user for all subsequent commands
USER appuser

# Set the shell to bash
SHELL ["/bin/bash", "-c"]

# Debug info and ensure Python is working
RUN echo "Python and pip location check:" && \
    echo "Python version: $(python --version)" && \
    echo "Python location: $(which python)" && \
    echo "Pip location: $(which pip)" && \
    echo "Current PATH: $PATH"

# Check if torch is installed before continuing
RUN if python -c "import torch" 2>/dev/null; then \
      echo "Torch is already installed."; \
      python -c "import torch; print('Torch version:', torch.__version__, 'CUDA available:', torch.cuda.is_available())"; \
    else \
      echo "Torch is not installed. Installing torch, torchvision, and torchaudio..."; \
      pip install "typing-extensions==4.13.2" && \
      pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128 --verbose; \
    fi

# Handle OpenVoice and MeloTTS installation
RUN if [ "$AIRUNNER_ENABLE_OPEN_VOICE" == "1" ]; then \
        if python -c "import openvoice" 2>/dev/null; then \
            echo "OpenVoice is already installed."; \
        else \
            echo "OpenVoice is not installed. Installing OpenVoice..."; \
            [ ! -d "OpenVoice" ] && git clone https://github.com/myshell-ai/OpenVoice.git; \
            cd OpenVoice && pip install --no-cache-dir -v . && cd .. && rm -rf OpenVoice; \
        fi; \
        if python -c "import melo" 2>/dev/null; then \
            echo "MeloTTS is already installed."; \
        else \
            echo "MeloTTS is not installed. Installing MeloTTS..."; \
            [ ! -d "MeloTTS" ] && git clone https://github.com/myshell-ai/MeloTTS.git; \
            cd MeloTTS && git checkout v0.1.2 && pip install --no-cache-dir -v . && cd .. && rm -rf MeloTTS; \
        fi; \
        echo "Downloading unidic..."; \
        python -m unidic download && echo "Unidic download complete."; \
    else \
        echo "Uninstalling OpenVoice and MeloTTS..."; \
        pip uninstall myshell-openvoice -y || true; \
        pip uninstall melotts -y || true; \
    fi

RUN pip install --no-cache-dir -v altgraph

# Handle Airunner installation
RUN if python -c "import airunner" 2>/dev/null; then \
        echo "Airunner is already installed."; \
        INSTALLED_VERSION=$(pip show airunner | grep Version | cut -d ' ' -f 2); \
        REQUIRED_VERSION=$(grep 'version=' /app/setup.py | sed -n "s/.*version=['\"]\([^'\"]*\)['\"].*/\1/p"); \
        echo "Installed version: $INSTALLED_VERSION"; \
        echo "Required version: $REQUIRED_VERSION"; \
        if [ "$INSTALLED_VERSION" != "$REQUIRED_VERSION" ]; then \
            echo "Airunner version $INSTALLED_VERSION is installed, but version $REQUIRED_VERSION is required."; \
            pip install --no-cache-dir -v -e .[all_dev] && \
            pip install --no-cache-dir -v -U langchain-community && \
            pip install --no-cache-dir -v -U timm; \
        else \
            echo "Airunner version $INSTALLED_VERSION is already installed."; \
        fi; \
    else \
        echo "Airunner is not installed. Installing the latest version..."; \
        pip install --no-cache-dir -v -e .[all_dev] && \
        pip install --no-cache-dir -v -U langchain-community && \
        pip install --no-cache-dir -v -U timm; \
    fi

# Handle NLTK punkt tokenizer installation
RUN if [ -f "/home/appuser/nltk_data/tokenizers/punkt/english.pickle" ]; then \
        echo "NLTK punkt tokenizer is already installed."; \
    else \
        echo "NLTK punkt tokenizer is not installed. Installing..."; \
        python -c "import nltk; nltk.download('punkt', quiet=True, halt_on_error=False, raise_on_error=False)"; \
        python -c "import nltk; nltk.download('stopwords', quiet=True, halt_on_error=False, raise_on_error=False)"; \
    fi