name: Windows Build

on:
  release:
    types: [ published ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

jobs:
  buildWindows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags and versioning

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          # Install PyTorch with CUDA support
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118

      - name: Get version from setup.py
        id: get_version
        shell: bash
        run: |
          VERSION=$(grep -oP '(?<=version=).*(?=,)' setup.py | tr -d '"')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: Build Windows executable
        run: |
          pyinstaller --noconfirm package/airunner.spec

      - name: Create dist directory structure for itch.io
        shell: bash
        run: |
          mkdir -p dist/windows
          cp -r dist/airunner/* dist/windows/
          # Copy additional required files
          cp package/windows.itch.toml dist/windows/
          # Create a launcher batch file if needed
          echo "@echo off" > dist/windows/airunner.bat
          echo "start airunner.exe" >> dist/windows/airunner.bat

      - name: Download and setup Butler
        shell: bash
        run: |
          curl -L -o butler.zip https://broth.itch.ovh/butler/windows-amd64/LATEST/archive/default
          unzip butler.zip
          chmod +x butler.exe

      - name: Deploy to itch.io with Butler
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        shell: bash
        run: |
          ./butler.exe push dist/windows capsizegames/ai-runner:windows --userversion ${{ env.VERSION }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: airunner-windows
          path: dist/windows/
          retention-days: 7