app-id: com.capsizegames.AIRunner
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm18

command: airunner

finish-args:
  # X11 + Wayland display access
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  
  # GPU access (OpenGL, Vulkan, CUDA)
  - --device=dri
  - --device=all  # Required for CUDA/GPU compute
  
  # Audio access (PulseAudio)
  - --socket=pulseaudio
  
  # Network access (for model downloads, API calls)
  - --share=network
  
  # File system access
  - --filesystem=home  # Access to user's home for models/data
  - --filesystem=xdg-documents  # For saving generated content
  - --filesystem=xdg-pictures  # For image generation output
  - --filesystem=/run/user/1000/pulse  # PulseAudio socket
  
  # D-Bus access for system integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  
  # Environment variables
  - --env=PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
  - --env=QT_QPA_PLATFORM=xcb
  - --env=AIRUNNER_FLATPAK=1

modules:
  # Python 3.13 build
  - name: python313
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.python.org/ftp/python/3.13.3/Python-3.13.3.tgz
        sha256: 3734b08e9d7cfaa896de1a3e2343d669f7cbacd5e27e4e50fbabe81d428b85c6
    config-opts:
      - --enable-optimizations
      - --with-lto
      - --enable-shared
      - --with-system-ffi
      - --with-ensurepip=install
    post-install:
      - ln -s python3.13 /app/bin/python3
      - ln -s python3.13 /app/bin/python
      - ln -s pip3.13 /app/bin/pip3
      - ln -s pip3.13 /app/bin/pip

  # PortAudio for audio I/O
  - name: portaudio
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz
        sha256: 5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release

  # MeCab for Japanese text processing (TTS)
  - name: mecab
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/taku910/mecab/archive/refs/tags/v0.996.tar.gz
        sha256: 4a07c4df024e0b0fbd8a84bc0f5a1f5c23a9af5a0d14b35e40baa09c5e4c54e2
    subdir: mecab

  - name: mecab-ipadic
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/taku910/mecab/archive/refs/tags/v0.996.tar.gz
        sha256: 4a07c4df024e0b0fbd8a84bc0f5a1f5c23a9af5a0d14b35e40baa09c5e4c54e2
    subdir: mecab-ipadic
    config-opts:
      - --with-mecab-config=/app/bin/mecab-config
      - --with-charset=utf8

  # FFmpeg for media processing
  - name: ffmpeg
    buildsystem: autotools
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-7.0.tar.xz
        sha256: 4426a94dd2c814945f66a8b186eaf6c0e6bd4fd97f1a0f53f6b7d98b4df92ddf
    config-opts:
      - --enable-shared
      - --disable-static
      - --disable-doc
      - --enable-gpl
      - --enable-version3

  # AI Runner application
  - name: airunner
    buildsystem: simple
    sources:
      - type: dir
        path: ..
    build-commands:
      # Create virtual environment
      - python3.13 -m venv /app/venv
      
      # Upgrade pip
      - /app/venv/bin/pip install --upgrade pip setuptools wheel
      
      # Install PyTorch with CUDA support
      # Note: Flatpak users need NVIDIA drivers on host + flatpak NVIDIA runtime
      - /app/venv/bin/pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128
      
      # Install AI Runner
      - /app/venv/bin/pip install ".[all]"
      
      # Create wrapper script
      - |
        cat > /app/bin/airunner << 'EOF'
        #!/bin/bash
        export PATH="/app/venv/bin:$PATH"
        export PYTHONPATH="/app/venv/lib/python3.13/site-packages:$PYTHONPATH"
        export LD_LIBRARY_PATH="/app/lib:$LD_LIBRARY_PATH"
        exec /app/venv/bin/python -m airunner "$@"
        EOF
      - chmod +x /app/bin/airunner
      
      # Create setup wrapper
      - |
        cat > /app/bin/airunner-setup << 'EOF'
        #!/bin/bash
        export PATH="/app/venv/bin:$PATH"
        export PYTHONPATH="/app/venv/lib/python3.13/site-packages:$PYTHONPATH"
        exec /app/venv/bin/python -m airunner.bin.airunner_setup "$@"
        EOF
      - chmod +x /app/bin/airunner-setup

  # Desktop integration files
  - name: desktop-files
    buildsystem: simple
    sources:
      - type: file
        path: com.capsizegames.AIRunner.desktop
      - type: file
        path: com.capsizegames.AIRunner.metainfo.xml
      - type: file
        path: icons/airunner-128.png
      - type: file
        path: icons/airunner-256.png
      - type: file
        path: icons/airunner-512.png
    build-commands:
      - install -Dm644 com.capsizegames.AIRunner.desktop /app/share/applications/com.capsizegames.AIRunner.desktop
      - install -Dm644 com.capsizegames.AIRunner.metainfo.xml /app/share/metainfo/com.capsizegames.AIRunner.metainfo.xml
      - install -Dm644 airunner-128.png /app/share/icons/hicolor/128x128/apps/com.capsizegames.AIRunner.png
      - install -Dm644 airunner-256.png /app/share/icons/hicolor/256x256/apps/com.capsizegames.AIRunner.png
      - install -Dm644 airunner-512.png /app/share/icons/hicolor/512x512/apps/com.capsizegames.AIRunner.png
