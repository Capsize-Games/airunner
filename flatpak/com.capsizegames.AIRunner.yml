app-id: com.capsizegames.AIRunner
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

command: airunner

finish-args:
  # X11 + Wayland display access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  
  # GPU access (OpenGL, Vulkan, CUDA)
  - --device=dri
  - --device=all  # Required for CUDA/GPU compute
  
  # Audio access (PulseAudio)
  - --socket=pulseaudio
  
  # Network access (for model downloads, API calls)
  - --share=network
  
  # File system access (app data uses sandboxed ~/.var/app/com.capsizegames.AIRunner/data automatically)
  - --filesystem=xdg-documents  # For saving generated content
  - --filesystem=xdg-pictures  # For image generation output
  - --filesystem=xdg-download:ro  # Read-only access to downloads (for importing models)
  
  # D-Bus access for system integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  
  # Environment variables
  - --env=PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
  - --env=QT_QPA_PLATFORM=xcb
  - --env=AIRUNNER_FLATPAK=1

modules:
  # Kerberos library (required by QtWebEngine)
  - name: krb5
    subdir: src
    buildsystem: autotools
    sources:
      - type: archive
        url: https://kerberos.org/dist/krb5/1.21/krb5-1.21.3.tar.gz
        sha256: b7a4cd5ead67fb08b980b21abd150ff7217e85ea320c9ed0c6dadd304840ad35
    config-opts:
      - --disable-static
      - --disable-rpath

  # Python 3.13 build
  - name: python313
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.python.org/ftp/python/3.13.3/Python-3.13.3.tgz
        sha256: 988d735a6d33568cbaff1384a65cb22a1fb18a9ecb73d43ef868000193ce23ed
    config-opts:
      - --enable-optimizations
      - --with-lto
      - --enable-shared
      - --with-system-ffi
      - --with-ensurepip=install
    post-install:
      - ln -sf python3.13 /app/bin/python3
      - ln -sf python3.13 /app/bin/python
      - ln -sf pip3.13 /app/bin/pip3
      - ln -sf pip3.13 /app/bin/pip

  # PortAudio for audio I/O (required for pyaudio)
  - name: portaudio
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz
        sha256: 5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release

  # AI Runner application
  - name: airunner
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    sources:
      - type: dir
        path: ..
    build-commands:
      # Create virtual environment
      - python3.13 -m venv /app/venv
      
      # Upgrade pip
      - /app/venv/bin/pip install --upgrade pip setuptools wheel
      
      # Install PyTorch with CUDA support
      # Note: Flatpak users need NVIDIA drivers on host + flatpak NVIDIA runtime
      - /app/venv/bin/pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128
      
      # Install AI Runner with specific extras (excluding Japanese/Korean TTS that require MeCab)
      # Excludes: openvoice_jp, openvoice_kr which need mecab-python3 and python-mecab-ko
      - /app/venv/bin/pip install ".[nvidia,huggingface,gui,linux,art,llm,llm_weather,tts,openvoice,melotts,openvoice_cn,openvoice_tw,gruut_support,search,computer_use]"
      
      # Create wrapper script
      - |
        cat > /app/bin/airunner << 'EOF'
        #!/bin/bash
        export PATH="/app/venv/bin:$PATH"
        export PYTHONPATH="/app/venv/lib/python3.13/site-packages:$PYTHONPATH"
        export LD_LIBRARY_PATH="/app/lib:$LD_LIBRARY_PATH"
        exec /app/venv/bin/python -c "from airunner.launcher import main; main()" "$@"
        EOF
      - chmod +x /app/bin/airunner
      
      # Create setup wrapper
      - |
        cat > /app/bin/airunner-setup << 'EOF'
        #!/bin/bash
        export PATH="/app/venv/bin:$PATH"
        export PYTHONPATH="/app/venv/lib/python3.13/site-packages:$PYTHONPATH"
        exec /app/venv/bin/python -c "from airunner.installer import main; main()" "$@"
        EOF
      - chmod +x /app/bin/airunner-setup

  # Desktop integration files
  - name: desktop-files
    buildsystem: simple
    sources:
      - type: file
        path: com.capsizegames.AIRunner.desktop
      - type: file
        path: com.capsizegames.AIRunner.metainfo.xml
      - type: file
        path: icons/airunner-128.png
      - type: file
        path: icons/airunner-256.png
      - type: file
        path: icons/airunner-512.png
    build-commands:
      - install -Dm644 com.capsizegames.AIRunner.desktop /app/share/applications/com.capsizegames.AIRunner.desktop
      - install -Dm644 com.capsizegames.AIRunner.metainfo.xml /app/share/metainfo/com.capsizegames.AIRunner.metainfo.xml
      - install -Dm644 airunner-128.png /app/share/icons/hicolor/128x128/apps/com.capsizegames.AIRunner.png
      - install -Dm644 airunner-256.png /app/share/icons/hicolor/256x256/apps/com.capsizegames.AIRunner.png
      - install -Dm644 airunner-512.png /app/share/icons/hicolor/512x512/apps/com.capsizegames.AIRunner.png
