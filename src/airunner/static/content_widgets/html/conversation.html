<!--
conversation.html: Jinja2 template for ConversationWidget
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: #111;
            color: #fff;
            box-sizing: border-box;
            overflow-x: hidden !important;
            width: 100vw;
            max-width: 100vw;
        }
        * {
            box-sizing: border-box;
        }
        #conversation-container {
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden !important;
            box-sizing: border-box;
            color: #fff;
            display: flex;
            flex-direction: column;
            gap: 18px;
            width: 100vw;
            max-width: 100vw;
        }
        .message {
            margin: 0 auto;
            padding: 20px;
            min-width: 100%;
            word-break: break-word;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            display: flex;
            flex-direction: column;
        }
        .message.user {
            background: #010101;
        }
        .message.assistant {
            background: #101010;
        }
        #conversation-container > .message:nth-child(even) {
            filter: brightness(1.08);
        }
        .message .sender {
            font-weight: 600;
            margin-bottom: 4px;
            color: #bdbdbd;
            font-size: 1em;
        }
        pre, code {
            color: #e0e0e0 !important;
            font-size: 1em;
            line-height: 1.5;
            padding: 8px 12px; /* Reduce padding for better fit */
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', 'monospace';
        }
        pre {
            margin: 8px 0 0 0;
            min-height: 32px;
            white-space: pre;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: auto;
        }
        code {
            padding: 2px 6px;
            white-space: pre-wrap;
        }
        .timestamp {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }
        .sender {
            font-weight: bold;
            margin-bottom: 2px;
        }
        /* Hide horizontal scrollbar for all browsers */
        #conversation-container::-webkit-scrollbar {
            height: 0 !important;
            width: 8px;
        }
        #conversation-container {
            scrollbar-width: thin;
            scrollbar-color: #444 #222;
        }
        /* Prevent horizontal scroll on body and html */
        html, body, #conversation-container, .message {
            overflow-x: hidden !important;
        }
    </style>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
        let chatBridge = null;
        window.isChatReady = false;
        window.chatReady = new Promise((resolve) => {
            document.addEventListener('DOMContentLoaded', function() {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    chatBridge = channel.objects.chatBridge;
                    chatBridge.appendMessage.connect(appendMessage);
                    chatBridge.clearMessages.connect(clearMessages);
                    chatBridge.setMessages.connect(function(msgs) {
                        clearMessages();
                        for (let i = 0; i < msgs.length; ++i) appendMessage(msgs[i], false);
                        setTimeout(smoothScrollToBottom, 0);
                        console.debug('[ConversationWidget] setMessages: rendered', msgs.length, 'messages');
                    });
                    window.isChatReady = true;
                    resolve();
                    console.debug('[ConversationWidget] QWebChannel ready');
                });
            });
        });
        function appendMessage(msg, scroll=true) {
            const container = document.getElementById('conversation-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'message ' + (msg.is_bot ? 'assistant' : 'user');
            div.innerHTML = `<div class="sender">${msg.name || msg.sender || ''}</div>`;
            div.innerHTML += msg.content;
            container.appendChild(div);
            if (scroll) setTimeout(smoothScrollToBottom, 0);
        }
        function clearMessages() {
            const container = document.getElementById('conversation-container');
            if (container) container.innerHTML = '';
        }
        function smoothScrollToBottom() {
            const container = document.getElementById('conversation-container');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'auto' // Use 'auto' for instant scroll on load
                });
            }
        }
        // MutationObserver for streaming updates
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('conversation-container');
            if (container) {
                const observer = new MutationObserver((mutations) => {
                    for (const mutation of mutations) {
                        if (mutation.addedNodes.length > 0) {
                            setTimeout(smoothScrollToBottom, 0);
                        }
                    }
                });
                observer.observe(container, { childList: true });
            }
        });
    </script>
</head>
<body>
<div id="conversation-container">
    <!-- Messages will be rendered via JS/QWebChannel only -->
</div>
</body>
</html>
